<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SMessage</title>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous"/>
<style>
/* GENEL STİLLER VE RENKLER */
*{margin:0;padding:0;box-sizing:border-box;font-family:'Open Sans',sans-serif;}
html,body{
    width:100%;height:100%;overflow:hidden;
    background: linear-gradient(0deg, #000000, #ffffff, #000000, #ffffff);
    background-size:400% 400%;
    animation:slowGradient 40s ease infinite;
    color:white;
}
@keyframes slowGradient{
    0%{background-position:0% 0%}
    25%{background-position:100% 0%}
    50%{background-position:100% 100%}
    75%{background-position:0% 100%}
    100%{background-position:0% 0%;}
}
@keyframes blinkWhite{
    0%,100%{opacity:1;color:white;}
    50%{opacity:0.2;color:#ffffff66;}
}
/* PROFİL PANELİ İÇİN "BOUNCE" EFEKTİ */
@keyframes bounce{
    0%,100%{transform:translateY(0);}
    25%{transform:translateY(-15px);}
    50%{transform:translateY(0px);}
    75%{transform:translateY(-5px);}
}
/* SOHBET BUTONU İÇİN BLINK EFEKTİ */
.sohbet-btn.blinking {
  animation: blinkWhite 1.5s infinite;
}
/* Pasif (disabled) buton stili */
.sohbet-btn[disabled],
.sohbet-btn[disabled]:hover {
  cursor: not-allowed;
  opacity: 0.5;
}

/* YENİ EFEKT: AÇILIŞ EKRANI VE ANİMASYONU */
.splash-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 9999;
    opacity: 1;
    transition: opacity 1s ease-in-out;
}
#smessager-logo {
    display: flex;
    font-family: 'Open Sans', sans-serif;
    font-weight: 300;
    font-size: 3rem;
    color: white;
    text-shadow: 0 0 10px rgba(255, 255, 255, 0.8),
                 0 0 20px rgba(255, 255, 255, 0.5);
    position: relative;
}
#smessager-logo span {
    display: inline-block;
    opacity: 1;
    transition: all 1s ease-in-out;
}
.dot-animation {
    position: absolute;
    width: 20px;
    height: 20px;
    background-color: white;
    border-radius: 50%;
    opacity: 0;
    transform: scale(0);
    transition: all 0.5s ease-in-out;
}
.dot-animation.show {
    opacity: 1;
    transform: scale(1);
    animation: dot-pulse 1.5s infinite;
}
@keyframes dot-pulse {
    0%, 100% { transform: scale(0.8); box-shadow: 0 0 10px rgba(255, 255, 255, 0.8), 0 0 20px rgba(255, 255, 255, 0.5); }
    50% { transform: scale(1.1); box-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 40px rgba(255, 255, 255, 0.8); }
}

.chat-container{
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:100%;
    display:flex;
    flex-direction:column;
    background-color:rgba(0,0,0,0.85);
    opacity: 0;
    transition: opacity 1s ease-in-out;
}
.profile-panel{
    display:flex;
    align-items:center;
    padding:15px 20px;
    gap:10px;
    background-color: rgba(0,0,0,0.6);
    justify-content:flex-end;
}
.sohbet-btn, #profileBtn{
    width:120px;
    height:45px;
    padding:0;
    margin:0;
    background-color: rgba(255,255,255,0.1);
    border:none;
    border-radius:5px;
    color:white;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:5px;
    font-size:14px;
}
.messages{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;}
.message{
    display:flex;
    gap:10px;
    max-width:70%;
    padding:10px;
    border-radius:10px;
    background-color:#000;
    color:white;
    border:1px solid white;
    position:relative;
}
.message.user{flex-direction:row-reverse;align-self:flex-end;}
.message.peer{flex-direction:row;align-self:flex-start;}
.message .profile-pic{width:40px;height:40px;border-radius:50%;object-fit:cover;}
.message .content{display:flex;flex-direction:column;}
.message .name{font-weight:bold;}
.message .text{margin-top:3px;}
.input-container{display:flex;padding:10px;background-color: rgba(255,255,255,0.05);align-items:center;gap:5px;margin-top:auto;}
#messageInput{
    flex:1;
    padding:10px 15px;
    border-radius:5px;
    border:none;
    outline:none;
    font-size:14px;
    color:white;
    background-color: rgba(255,255,255,0.1);
    resize:none;
    min-height:45px;
    max-height: 200px;
    overflow-y: auto;
    line-height: 1.5;
}
.input-container button{width:45px;height:45px;background-color: rgba(255,255,255,0.1);border:none;border-radius:5px;cursor:pointer;display:flex;justify-content:center;align-items:center;transition: all 0.3s ease;color:white;font-size:18px;}
.input-container button:hover{background-color: rgba(255,255,255,0.3);transform:scale(1.05);}
#profilePanel{
    position:absolute;
    top:60px;
    left:50px;
    width:250px;
    background-color:rgba(0,0,0,0.95);
    padding:15px;
    border-radius:10px;
    display:none;
    flex-direction:column;
    gap:10px;
    cursor:move;
    z-index:1000;
    transition: left 0.3s ease-out, top 0.3s ease-out;
}
.active-panel{
    animation:bounce 0.6s ease-out;
}
#profilePanel label{font-size:14px;}
#profilePanel img{width:60px;height:60px;border-radius:50%;object-fit:cover;cursor:pointer;}
#profilePanel input[type="text"]{padding:5px;border-radius:5px;border:none;outline:none;}
#profilePanel button{width:100%;padding:8px;border-radius:5px;border:none;background-color:rgba(255,255,255,0.2);color:white;cursor:pointer;}
#peerProfile{position:absolute;top:10px;left:10px;display:flex;align-items:center;gap:5px;background-color: rgba(255,255,255,0.05);padding:5px 10px;border-radius:10px; opacity: 1; transition: opacity 1s ease-in-out;}
#peerProfile img{width:40px;height:40px;border-radius:50%;object-fit:cover;}
.status-message {
    text-align: center;
    padding: 10px;
    color: white;
    font-size: 14px;
    opacity: 0.7;
}
</style>
</head>
<body>
<div class="splash-screen">
    <div id="smessager-logo">
        <span>S</span>
        <span>M</span>
        <span>e</span>
        <span>s</span>
        <span>s</span>
        <span>a</span>
        <span>g</span>
        <span>e</span>
        <span>r</span>
    </div>
</div>

<div class="chat-container">
    <div class="profile-panel">
        <button class="sohbet-btn" id="createRoomBtn" disabled><i class="fas fa-link"></i> Bağlanıyor...</button>
        <button id="profileBtn"><i class="fas fa-user-cog"></i></button>
    </div>
    <div class="status-message" id="statusMessage">Sohbet başlatmak için "Sohbet Kur" butonuna tıkla.</div>
    <div class="messages" id="messages"></div>

    <div class="input-container">
        <button class="send-btn"><i class="fas fa-paper-plane"></i></button>
        <textarea id="messageInput" rows="1" placeholder="Mesaj yaz..."></textarea>
        <button class="photo-btn"><i class="fas fa-image"></i></button>
        <button class="audio-btn"><i class="fas fa-microphone"></i></button>
        <input type="file" id="imageInput" accept="image/*" style="display:none;">
    </div>
</div>

<div id="profilePanel">
    <label>Profil Resmi</label>
    <img id="profileImg" src="https://cdn-icons-png.flaticon.com/512/149/149071.png"><br>
    <input type="file" id="profileImgInput" accept="image/*">
    <label>Kullanıcı Adı</label>
    <input type="text" id="profileNameInput" value="Anonim">
    <button id="saveProfileBtn">Kaydet</button>
</div>

<div id="peerProfile">
    <img id="peerAvatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
    <span id="peerName">Arkadaşın Bekleniyor...</span>
</div>

<!-- Firebase SDK'ları buraya ekleniyor -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

document.addEventListener('DOMContentLoaded', async () => {
    // GENEL DEĞİŞKENLER
    const messagesContainer = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.querySelector('.send-btn');
    const audioBtn = document.querySelector('.audio-btn');
    const photoBtn = document.querySelector('.photo-btn');
    const imageInput = document.getElementById('imageInput');
    const splashScreen = document.querySelector('.splash-screen');
    const chatContainer = document.querySelector('.chat-container');
    const peerProfile = document.getElementById('peerProfile');
    const smessagerLogo = document.getElementById('smessager-logo');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const statusMessage = document.getElementById('statusMessage');

    const profileBtn = document.getElementById('profileBtn');
    const profilePanel = document.getElementById('profilePanel');
    const profileImgInput = document.getElementById('profileImgInput');
    const profileImg = document.getElementById('profileImg');
    const profileNameInput = document.getElementById('profileNameInput');
    const saveProfileBtn = document.getElementById('saveProfileBtn');

    let userProfile = { name: 'Anonim', avatar: 'https://cdn-icons-png.flaticon.com/512/149/149071.png' };
    let roomId = null;
    let userId = null;
    let db, auth, authReady = false;
    let messageUnsub, profileUnsub;

    // Firebase'i başlat ve kullanıcıyı anonim olarak veya token ile oturum açtır
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    if (Object.keys(firebaseConfig).length > 0) {
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    authReady = true;
                    console.log('User signed in with UID:', userId);
                    // Kullanıcı oturum açtıktan sonra URL'yi kontrol et
                    checkUrlForRoomId();
                } else {
                    console.log('No user signed in. Attempting anonymous sign-in.');
                    if (typeof __initial_auth_token !== 'undefined') {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                }
            });
        } catch (error) {
            console.error("Firebase başlatılırken hata oluştu:", error);
        }
    } else {
        console.error("Firebase yapılandırması bulunamadı. Lütfen __firebase_config global değişkenini kontrol edin.");
    }

    // URL'deki oda kimliğini kontrol eden yeni işlev
    function checkUrlForRoomId() {
        const urlParams = new URLSearchParams(window.location.search);
        const roomFromUrl = urlParams.get('room');
        if (roomFromUrl) {
            console.log(`URL'de oda kimliği bulundu: ${roomFromUrl}`);
            roomId = roomFromUrl;
            joinRoom(roomId);
            createRoomBtn.disabled = true;
            createRoomBtn.innerHTML = `<i class="fas fa-link"></i> Odaya Katıldın`;
            createRoomBtn.classList.remove('blinking');
        } else {
            console.log("URL'de oda kimliği bulunamadı, yeni bir sohbet başlat.");
            createRoomBtn.disabled = false;
            createRoomBtn.innerHTML = `<i class="fas fa-link"></i> Sohbet Kur`;
            createRoomBtn.classList.add('blinking');
        }
    }
    
    // Sohbet odası oluşturma ve katılma
    createRoomBtn.addEventListener('click', async () => {
        if (!authReady) {
            console.warn("Auth hazır değil. Lütfen bekleyin.");
            return;
        }

        const newRoomId = generateRoomId();
        const url = `${window.location.origin}${window.location.pathname}?room=${newRoomId}`;
        window.history.pushState({}, '', url);
        roomId = newRoomId;
        await joinRoom(roomId);

        // Kodu kopyalama işlevi için butonu güncelle
        createRoomBtn.innerHTML = `<i class="fas fa-copy"></i> Kodu Kopyala`;
        createRoomBtn.classList.remove('blinking');
        statusMessage.textContent = 'Sohbet bağlantısı kopyalandı!';
        setTimeout(() => {
            statusMessage.textContent = `Sohbet Odası: ${roomId}`;
        }, 3000);
    });

    function generateRoomId() {
        return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    async function joinRoom(id) {
        if (!db) {
            console.error("Firestore başlatılmamış.");
            return;
        }
        statusMessage.textContent = `Oda: ${id} - Bağlanılıyor...`;
        
        messagesContainer.innerHTML = '';
        console.log("Odaya Katılıyor:", id);

        // Kendi profil bilgilerimizi Firestore'a kaydet
        const userProfileRef = doc(db, "artifacts", "__app_id", "public", "data", "rooms", id, "users", userId);
        await setDoc(userProfileRef, {
            name: userProfile.name,
            avatar: userProfile.avatar,
            timestamp: serverTimestamp()
        }, { merge: true });

        // Gerçek zamanlı mesaj dinleyicisi
        const messagesRef = collection(db, "artifacts", "__app_id", "public", "data", "rooms", id, "messages");
        const q = query(messagesRef, orderBy("timestamp"), limit(50));
        messageUnsub = onSnapshot(q, (snapshot) => {
            snapshot.docChanges().forEach(change => {
                if (change.type === "added") {
                    const messageData = change.doc.data();
                    const sender = messageData.senderId === userId ? 'user' : 'peer';
                    const content = { text: messageData.text };
                    addMessage(content, sender, messageData.profile);
                }
            });
            statusMessage.textContent = `Sohbet Odası: ${id}`;
        }, (error) => {
            console.error("Mesajlar dinlenirken hata oluştu:", error);
            statusMessage.textContent = 'Bağlantı Hatası!';
            resetChat();
        });

        // Diğer kullanıcıların profil bilgilerini dinle
        const usersRef = collection(db, "artifacts", "__app_id", "public", "data", "rooms", id, "users");
        profileUnsub = onSnapshot(usersRef, (snapshot) => {
            snapshot.docChanges().forEach(change => {
                const userData = change.doc.data();
                if (change.doc.id !== userId) {
                    // Akran profilini güncelle
                    document.getElementById('peerName').textContent = userData.name;
                    document.getElementById('peerAvatar').src = userData.avatar;
                }
            });
        }, (error) => {
            console.error("Kullanıcı profilleri dinlenirken hata oluştu:", error);
        });
    }

    function resetChat() {
      if (messageUnsub) messageUnsub();
      if (profileUnsub) profileUnsub();
      roomId = null;
      messagesContainer.innerHTML = '';
      createRoomBtn.innerHTML = `<i class="fas fa-link"></i> Sohbet Kur`;
      createRoomBtn.classList.add('blinking');
      statusMessage.textContent = 'Sohbet başlatmak için "Sohbet Kur" butonuna tıkla.';
      window.history.pushState({}, '', window.location.pathname);
    }
    
    // YENİ ANİMASYON İŞLEVİ
    function startSplashAnimation() {
        const letters = smessagerLogo.querySelectorAll('span');
        const dot = document.createElement('div');
        dot.className = 'dot-animation';
        smessagerLogo.appendChild(dot);

        // Her harfi ortaya doğru küçülterek hareket ettirir
        letters.forEach((letter, index) => {
            const logoRect = smessagerLogo.getBoundingClientRect();
            const letterRect = letter.getBoundingClientRect();
            
            // Ortaya olan mesafeyi hesaplar
            const centerX = logoRect.width / 2 - (letterRect.left - logoRect.left + letterRect.width / 2);
            const centerY = logoRect.height / 2 - (letterRect.top - logoRect.top + letterRect.height / 2);

            letter.style.transform = `translate(${centerX}px, ${centerY}px) scale(0.1)`;
            letter.style.opacity = '0';
        });

        // Harflerin toplanmasından sonra nokta animasyonunu başlatır
        setTimeout(() => {
            dot.style.left = '50%';
            dot.style.top = '50%';
            dot.style.transform = 'translate(-50%, -50%)';
            dot.classList.add('show');
        }, 1000); // Harflerin toplanma süresi sonrası

        // Tüm animasyon bittikten sonra ana ekranı gösterir
        setTimeout(() => {
            splashScreen.style.opacity = '0';
            splashScreen.addEventListener('transitionend', () => {
                splashScreen.style.display = 'none';
            }, { once: true });
            chatContainer.style.opacity = '1';
        }, 3000); // Animasyonun toplam süresi
    }

    startSplashAnimation();

    // Sohbet mesajını ekleme işlevi
    function addMessage(content, sender, profile) {
        const msg = document.createElement('div');
        msg.classList.add('message', sender);
    
        const profilePic = document.createElement('img');
        profilePic.className = 'profile-pic';
        profilePic.src = profile.avatar;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'content';

        const nameEl = document.createElement('div');
        nameEl.className = 'name';
        nameEl.textContent = profile.name;
    
        const textEl = document.createElement('div');
        textEl.className = 'text';

        if (content.text) {
            textEl.innerHTML = content.text.replace(/\n/g, '<br>');
        }
    
        contentDiv.appendChild(nameEl);
        contentDiv.appendChild(textEl);

        if (content.img) contentDiv.appendChild(content.img);

        msg.appendChild(profilePic);
        msg.appendChild(contentDiv);
    
        messagesContainer.appendChild(msg);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Mesaj gönderme işlevi
    sendBtn.addEventListener('click', async () => {
        const text = messageInput.value.trim();
        if (!text || !roomId || !db) return;
        
        const messagesRef = collection(db, "artifacts", "__app_id", "public", "data", "rooms", roomId, "messages");
        try {
            await addDoc(messagesRef, {
                text: text,
                senderId: userId,
                profile: userProfile,
                timestamp: serverTimestamp()
            });
            messageInput.value = '';
            messageInput.style.height = '45px';
        } catch (e) {
            console.error("Mesaj gönderilirken hata:", e);
        }
    });

    // Kodu kopyalama işlevi
    function copyToClipboard(text) {
        if (!navigator.clipboard) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            return;
        }
        navigator.clipboard.writeText(text).then(() => {
            console.log('Async: Copying to clipboard was successful!');
        }).catch(err => {
            console.error('Async: Could not copy text: ', err);
        });
    }

    // Profil panelinin işlevleri
    profileBtn.addEventListener('click', () => {
        if (profilePanel.style.display === 'flex') {
            profilePanel.style.display = 'none';
            profilePanel.classList.remove('active-panel');
        } else {
            profilePanel.style.display = 'flex';
            profilePanel.classList.add('active-panel');
        }
    });

    profileImg.addEventListener('click', () => { profileImgInput.click(); });
    profileImgInput.addEventListener('change', function () {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = e => { 
                profileImg.src = e.target.result; 
                userProfile.avatar = e.target.result; 
                if (roomId && db) {
                     const userProfileRef = doc(db, "artifacts", "__app_id", "public", "data", "rooms", roomId, "users", userId);
                     setDoc(userProfileRef, { avatar: userProfile.avatar }, { merge: true });
                }
            }
            reader.readAsDataURL(file);
        }
    });

    saveProfileBtn.addEventListener('click', async () => { 
        userProfile.name = profileNameInput.value || 'Anonim'; 
        profilePanel.style.display = 'none'; 
        if (roomId && db) {
            const userProfileRef = doc(db, "artifacts", "__app_id", "public", "data", "rooms", roomId, "users", userId);
            await setDoc(userProfileRef, { name: userProfile.name }, { merge: true });
        }
    });

    // YENİ ÖZELLİK: SHIFT+ENTER İLE ALT SATIRA GEÇME
    messageInput.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendBtn.click();
        }
    });

    // YENİ ÖZELLİK: TEXTAREA OTOMATİK BÜYÜME
    messageInput.addEventListener('input', () => {
        messageInput.style.height = 'auto';
        messageInput.style.height = messageInput.scrollHeight + 'px';
    });

    photoBtn.addEventListener('click', () => { imageInput.click(); });
    imageInput.addEventListener('change', function () {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = e => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.maxWidth = '100%';
                img.style.borderRadius = '10px';
                addMessage({ img: img }, 'user');
            }
            reader.readAsDataURL(file);
        }
    });

    let mediaRecorder, audioChunks = [], recording = false;
    audioBtn.addEventListener('click', async () => {
        if (recording) { mediaRecorder.stop(); recording = false; }
        else {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            recording = true;
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const audioURL = URL.createObjectURL(blob);
                const audio = document.createElement('audio');
                audio.controls = true;
                audio.src = audioURL;
                addMessage({ img: audio }, 'user');
            };
        }
    });

    let isDragging = false, offsetX = 0, offsetY = 0;
    profilePanel.addEventListener('mousedown', (e) => { isDragging = true; offsetX = e.clientX - profilePanel.offsetLeft; offsetY = e.clientY - profilePanel.offsetTop; });

    document.addEventListener('mouseup', () => {
        isDragging = false;
        const slideDistance = 30;
        let newLeft = profilePanel.offsetLeft + slideDistance;
        let newTop = profilePanel.offsetTop;

        const panelWidth = profilePanel.offsetWidth;
        const panelHeight = profilePanel.offsetHeight;
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;

        if (newLeft < 0) {
            newLeft = 10;
        } else if (newLeft + panelWidth > windowWidth) {
            newLeft = windowWidth - panelWidth - 10;
        }

        if (newTop < 0) {
            newTop = 10;
        } else if (newTop + panelHeight > windowHeight) {
            newTop = windowHeight - panelHeight - 10;
        }

        profilePanel.style.left = newLeft + 'px';
        profilePanel.style.top = newTop + 'px';
    });

    document.addEventListener('mousemove', (e) => {
        if (isDragging) {
            let newLeft = e.clientX - offsetX;
            let newTop = e.clientY - offsetY;

            const panelWidth = profilePanel.offsetWidth;
            const panelHeight = profilePanel.offsetHeight;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            if (newLeft < 0) newLeft = 0;
            if (newLeft + panelWidth > windowWidth) newLeft = windowWidth - panelWidth;
            if (newTop < 0) newTop = 0;
            if (newTop + panelHeight > windowHeight) newTop = windowHeight - panelHeight;

            profilePanel.style.left = newLeft + 'px';
            profilePanel.style.top = newTop + 'px';
        }
    });
});
</script>
</body>
</html>
